box: python:2.7
no-response-timeout: 15
dev:
  services:
    - redis
    - id: mattapi
      url: file://../ws_api#dev
      cmd: python /pipeline/source/app.py

  steps:
    - pip-install
    - internal/watch:
        name: start web server
        code: python app.py
        reload: true
build:
  services:
    - redis
    - tonnu/mattapi
  steps:
    - pip-install
    - script:
        name: copy artifacts
        code: |
          cp wercker-app.json hello-task-definition.json app.py requirements.txt $WERCKER_OUTPUT_DIR
    - script:
        name: copy artifacts2
        code: |
          mkdir /app && cp app.py /app
    - internal/docker-push:
          username: $DOCKER_USER
          password: $DOCKER_PASS
          repository: tonnu/ws_web
          cmd: "python /pipeline/source/app.py"
          ports: 80
deploy:
  box: python:2.7-slim
  steps:
   - script:
       name: copy
       code: mkdir /app && cp app.py hello-task-definition.json wercker-app.json /app/
   - tonnu/aws-ecs:
      key: $AWS_ACCESS_KEY
      secret: $AWS_SECRET_KEY
      region: us-east-1
      cluster-name: default
      service-name: hello
      task-definition-name: hello
      task-definition-file: /app/wercker-app.json
      minimum-running-tasks: 1
